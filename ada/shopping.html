<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic HTML document setup -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetWise - Shopping List</title>
    <!-- Link to external CSS file for base styling -->
    <link rel="stylesheet" href="styles.css">
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
    <style>
        /* Shopping page specific styles */
        /* Body styling with background image */
        body {
            background-image: url('./assets/shop-bg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }
        
        /* Main container for the shopping page layout */
        .shopping-container {
            position: relative;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
        }
        
        /* Alternative options container */
        .alternatives-container {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }
        
        /* Individual alternative option card */
        .alternative-card {
            width: 200px;
            height: 120px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .alternative-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: #4CAF50;
        }
        
        .alternative-card.selected {
            border-color: #4CAF50;
            background: #E8F5E8;
        }
        
        .card-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .card-price {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .card-emissions {
            font-size: 11px;
            color: #888;
        }
        
        /* Shopping list item states */
        .current-item {
            background-color: #E3F2FD;
            border-left: 4px solid #2196F3;
            padding-left: 10px;
            font-weight: bold;
        }
        
        .processed-item {
            background-color: #E8F5E8;
            border-left: 4px solid #4CAF50;
            padding-left: 10px;
            opacity: 0.7;
        }
        
        /* Shopping list paper - styled to look like a real piece of paper */
        .shopping-paper {
            width: 300px;
            height: 450px;
            background: #FFF8DC; /* Cream color for paper */
            border-radius: 15px;
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.3), /* Drop shadow for depth */
                inset 0 1px 0 rgba(255, 255, 255, 0.8); /* Inner highlight */
            padding: 30px;
            transform: rotate(-2deg); /* Slight rotation for natural look */
            border: 3px solid #F5DEB3; /* Light brown border */
            margin-left: 30px;
            position: relative; /* Needed for loading overlay positioning */
        }
        
        /* Loading overlay that appears while AI processes the shopping list */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 248, 220, 0.9); /* Semi-transparent paper color */
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10; /* Above other content */
        }
        
        /* Animated spinner for loading indication */
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #F5DEB3; /* Light border */
            border-top: 3px solid #8B4513; /* Dark top border for rotation effect */
            border-radius: 50%;
            animation: spin 1s linear infinite; /* Continuous rotation */
            margin-bottom: 15px;
        }
        
        /* Keyframe animation for spinner rotation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Text that appears below the loading spinner */
        .loading-text {
            color: #8B4513; /* Dark brown to match theme */
            font-size: 1em;
            font-weight: 500;
            text-align: center;
        }
        
        .paper-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 3px solid #8B4513;
            padding-bottom: 15px;
        }
        
        .paper-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #8B4513;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .budget-display {
            font-size: 1.2em;
            color: #2F4F4F;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .shopping-list {
            list-style: none;
            padding: 15px;
            margin: 0;
            max-height: 280px; /* Limit height to make it scrollable */
            overflow-y: auto; /* Enable vertical scrolling */
            background: #FFF8DC; /* Same color as paper */
            border: 2px solid #8B4513; /* Dark brown border like a text field */
            border-radius: 8px; /* Rounded corners to match paper */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); /* Inner shadow for field effect */
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
        }
        
        .shopping-list li {
            padding: 4px 0;
            color: #2F4F4F;
            font-size: 1em;
            font-weight: 500;
            border-bottom: none; /* Remove lines between items */
            margin-bottom: 2px;
        }
        
        .shopping-list li:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Custom scrollbar styling to match the paper theme */
        .shopping-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .shopping-list::-webkit-scrollbar-track {
            background: #F5DEB3; /* Light brown track */
            border-radius: 4px;
        }
        
        .shopping-list::-webkit-scrollbar-thumb {
            background: #8B4513; /* Dark brown thumb */
            border-radius: 4px;
        }
        
        .shopping-list::-webkit-scrollbar-thumb:hover {
            background: #654321; /* Darker brown on hover */
        }
        
        /* Back button */
        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            color: #FFF8DC;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .shopping-container {
                justify-content: center;
            }
            
            .shopping-paper {
                width: 280px;
                height: 400px;
                padding: 25px;
                margin-left: 0;
                transform: rotate(-1deg);
            }
            
            .back-button {
                top: 20px;
                left: 20px;
                padding: 12px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <!-- Main container for the shopping page -->
    <div class="shopping-container">
        <!-- Navigation button to return to the main budget form -->
        <button class="back-button" onclick="goBack()">‚Üê Back to Budget</button>
        
        <!-- Alternative options container -->
        <div class="alternatives-container" id="alternativesContainer">
            <!-- Alternative option cards will be populated here -->
        </div>
        
        <!-- Shopping list paper - the main content area -->
        <div class="shopping-paper">
            <!-- Loading overlay that shows while AI processes the shopping list -->
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">Filtering your list...</div>
            </div>
            
            <!-- Header section of the paper with title and budget -->
            <div class="paper-header">
                <h2 class="paper-title">Shopping List</h2>
                <div class="budget-display" id="budgetDisplay">Budget: ¬£0</div>
            </div>
            <!-- List container where cleaned shopping items will be displayed -->
            <ul class="shopping-list" id="shoppingList">
                <!-- Shopping items will be populated by JavaScript after AI processing -->
            </ul>
        </div>
    </div>
    
    <!-- Load the food data script -->
    <script src="extractFoodInfo.js"></script>
    
    <script>
        // Global variables for managing the shopping list and alternatives
        let currentShoppingList = [];
        let currentItemIndex = 0;
        // foodTable is declared in extractFoodInfo.js
        
        // Initialize food data when the page loads
        async function initializeFoodData() {
            // Wait for the food data to load from JSON
            if (typeof loadFoodData !== 'undefined') {
                await loadFoodData();
                console.log('‚úÖ Food data loaded:', foodTable.length, 'items');
            } else {
                console.warn('‚ö†Ô∏è loadFoodData function not available, using fallback data');
                // Fallback data if extractFoodInfo.js doesn't load
                foodTable = [
                    { CommonValues: "Apples", PRICE: 2.50, EMISSIONS: 0.4 },
                    { CommonValues: "Bananas", PRICE: 1.80, EMISSIONS: 0.3 },
                    { CommonValues: "Bread", PRICE: 1.20, EMISSIONS: 0.8 },
                    { CommonValues: "Chicken", PRICE: 4.50, EMISSIONS: 2.1 },
                    { CommonValues: "Milk", PRICE: 1.10, EMISSIONS: 0.6 }
                ];
            }
        }
        
        // Function to find similar food items using AI and the Excel data
        async function findSimilarItems(itemName) {
            // First try to use the Excel data to find similar items
            if (typeof findSimilarFoodItems !== 'undefined') {
                const similarItems = findSimilarFoodItems(itemName, foodTable);
                if (similarItems.length > 0) {
                    return similarItems.map(item => item.name);
                }
            }
            
            // If no similar items found in Excel data, use AI via proxy server
            const API_URL = 'http://localhost:3001/api/claude';
            
            const prompt = `You are a food category expert. Given a food item, suggest 2 similar alternatives from the same food category.

Food item: "${itemName}"

Available food categories and examples:
- Fruit: apples, bananas, oranges, grapes, strawberries
- Meat: chicken, beef, pork, lamb, turkey
- Dairy: milk, cheese, yogurt, butter
- Bakery: bread, croissants, bagels, muffins
- Grain: rice, pasta, quinoa, oats
- Vegetables: carrots, broccoli, spinach, tomatoes

Return exactly 2 similar food items as a comma-separated list. Only return the names, nothing else.

Example: If input is "apples", return: "Bananas, Oranges"`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shoppingList: itemName
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                if (data.success && data.items) {
                    return data.items.slice(0, 2); // Take only first 2
                } else {
                    throw new Error('Invalid response from proxy server');
                }
            } catch (error) {
                console.error('Error finding similar items:', error);
                // Fallback to simple alternatives
                return getFallbackAlternatives(itemName);
            }
        }
        
        // Simple fallback function for finding alternatives
        function getFallbackAlternatives(itemName) {
            const lowerItem = itemName.toLowerCase();
            if (lowerItem.includes('apple') || lowerItem.includes('fruit')) {
                return ['Bananas', 'Oranges'];
            } else if (lowerItem.includes('bread') || lowerItem.includes('bakery')) {
                return ['Croissants', 'Bagels'];
            } else if (lowerItem.includes('chicken') || lowerItem.includes('meat')) {
                return ['Beef', 'Pork'];
            } else if (lowerItem.includes('milk') || lowerItem.includes('dairy')) {
                return ['Cheese', 'Yogurt'];
            } else {
                return ['Similar Item 1', 'Similar Item 2'];
            }
        }
        
        // Function to get food data (price and emissions) using the original function
        function getFoodData(foodName) {
            // Use the original findPriceAndEmissions function from extractFoodInfo.js
            const result = findPriceAndEmissions(foodName, foodTable);
            if (result) {
                return {
                    name: foodName,
                    price: result.price,
                    emissions: result.emissions
                };
            } else {
                return { name: foodName, price: 0, emissions: 0 };
            }
        }
        
        // Function to create alternative option cards
        function createAlternativeCards(originalItem, alternatives) {
            const container = document.getElementById('alternativesContainer');
            container.innerHTML = '';
            
            // Create original item card
            const originalData = getFoodData(originalItem);
            const originalCard = createCard(originalItem, originalData, true);
            container.appendChild(originalCard);
            
            // Create alternative cards
            alternatives.forEach(altItem => {
                const altData = getFoodData(altItem);
                const altCard = createCard(altItem, altData, false);
                container.appendChild(altCard);
            });
            
            container.style.display = 'flex';
        }
        
        // Function to create individual cards
        function createCard(itemName, data, isOriginal) {
            const card = document.createElement('div');
            card.className = 'alternative-card';
            if (isOriginal) card.classList.add('selected');
            
            card.innerHTML = `
                <div class="card-title">${itemName}</div>
                <div class="card-price">Price: ¬£${data.price.toFixed(2)}</div>
                <div class="card-emissions">Emissions: ${data.emissions}kg CO2</div>
            `;
            
            card.onclick = () => selectAlternative(itemName, isOriginal);
            return card;
        }
        
        // Function to handle alternative selection
        function selectAlternative(selectedItem, isOriginal) {
            if (!isOriginal) {
                // Replace the current item in the list
                currentShoppingList[currentItemIndex] = selectedItem;
                updateShoppingListDisplay();
            }
            
            // Move to next item
            currentItemIndex++;
            if (currentItemIndex < currentShoppingList.length) {
                processNextItem();
            } else {
                // All items processed
                document.getElementById('alternativesContainer').style.display = 'none';
                alert('All items processed! Your final shopping list is ready.');
            }
        }
        
        // Function to process the next item in the list
        async function processNextItem() {
            if (currentItemIndex >= currentShoppingList.length) return;
            
            const currentItem = currentShoppingList[currentItemIndex];
            const alternatives = await findSimilarItems(currentItem);
            createAlternativeCards(currentItem, alternatives);
        }
        
        // Function to update the shopping list display
        function updateShoppingListDisplay() {
            const shoppingListElement = document.getElementById('shoppingList');
            shoppingListElement.innerHTML = currentShoppingList.map((item, index) => {
                const isCurrent = index === currentItemIndex;
                const isProcessed = index < currentItemIndex;
                let className = '';
                if (isCurrent) className = 'current-item';
                if (isProcessed) className = 'processed-item';
                return `<li class="${className}">${item}</li>`;
            }).join('');
        }

        // Function to extract budget and shopping list data from URL parameters
        // This allows data to be passed from the main form to this shopping page
        function getUrlParameters() {
            // Create URLSearchParams object to parse query string
            const urlParams = new URLSearchParams(window.location.search);
            return {
                budget: urlParams.get('budget') || '0', // Get budget amount, default to '0'
                shoppingList: urlParams.get('list') || '' // Get shopping list, default to empty string
            };
        }
        
        // AI cleanup function that processes and validates the shopping list
        // This uses Claude AI to clean up grammar, remove invalid items, and standardize format
        async function cleanupShoppingList(shoppingList) {
            // Only use Claude AI for all cleanup tasks - no fallback processing
            console.log('ü§ñ Using Claude AI to filter and clean your shopping list');
            const cleanedItems = await callAIAPI(shoppingList);
            return cleanedItems;
        }
        
        // Real AI API call function using proxy server
        async function callAIAPI(shoppingList) {
            // Use the proxy server to avoid CORS issues
            const API_URL = 'http://localhost:3001/api/claude';
            
            console.log('ü§ñ Calling Anthropic Claude API with list:', shoppingList);
            console.log('üîë Using API endpoint:', API_URL);
            
            const prompt = `You are an intelligent shopping list parser for a UK grocery store. Your job is to understand what the user actually wants to buy, even if they write it poorly.

Original input: "${shoppingList}"

CRITICAL PARSING RULES:
1. SMART SEPARATION: Understand what are separate items vs. parts of one item name
   - "beans. bug" = "Beans, Bug" (two separate items)
   - "green beans" = "Green beans" (one item with descriptor)
   - "car car apples" = "Apples" (ignore non-grocery, keep grocery)
   - "apple pie" = "Apple pie" (one item)
   - "apple, pie" = "Apple, Pie" (two separate items)

2. INTELLIGENT PARSING: Look for natural separators and context
   - Commas, periods, semicolons, "and", "&" = separate items
   - Spaces within descriptive names = one item
   - Numbers + items = one item (e.g., "2 apples" = "Apples")

3. CONTEXT UNDERSTANDING: Use grocery store knowledge
   - "beans" = grocery item
   - "bug" = not a grocery item (remove)
   - "car" = not a grocery item (remove)
   - "green beans" = one grocery item
   - "baked beans" = one grocery item

YOUR TASKS:
1. PARSE CORRECTLY: Identify separate grocery items vs. single items with descriptors
2. GRAMMAR & SPELLING: Fix all mistakes and typos
3. REMOVE NON-GROCERY: Remove cars, phones, bugs, toys, electronics, etc.
4. UK TERMINOLOGY: Convert to British English (cookies‚Üíbiscuits, soda‚Üísoft drinks)
5. COMBINE DUPLICATES: If same item appears multiple times, make it plural
6. PROPER CAPITALIZATION: Capitalize correctly
7. STANDARDIZE NAMES: Use proper grocery store names

EXAMPLES:
- "car car apples" ‚Üí "Apples"
- "beans. bug" ‚Üí "Beans"
- "green beans, baked beans" ‚Üí "Green beans, Baked beans"
- "apple pie, apple" ‚Üí "Apple pie, Apple"
- "2 apples, 3 bananas" ‚Üí "Apples, Bananas"
- "cookies, soda" ‚Üí "Biscuits, Soft drinks"
- "please buy milk and bread" ‚Üí "Milk, Bread"

Return ONLY the cleaned grocery items as a comma-separated string. No explanations.`;
            
            try {
                console.log('üì° Making API request to Anthropic Claude');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shoppingList: shoppingList
                    })
                });
                    
                    console.log('üìä API Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå API Error Response:', errorText);
                        throw new Error(`Anthropic Claude API error: ${response.status} - ${response.statusText}. Details: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ API Response data:', data);
                    
                    if (!data.success || !data.items) {
                        console.error('‚ùå Invalid API response structure:', data);
                        throw new Error('Invalid response from proxy server');
                    }
                    
                    const result = data.items;
                    console.log('üìù Final processed items:', result);
                    return result;
                    
            } catch (error) {
                console.error('‚ùå Anthropic Claude API call failed:', error);
                console.error('‚ùå Error details:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                console.log('üîÑ Falling back to basic processing...');
                throw error;
            }
        }
        
        
        // Main function that displays the budget and processes the shopping list with Claude AI
        async function displayShoppingList() {
            // Get the budget and shopping list from URL parameters
            const params = getUrlParameters();
            
            // Display the budget amount at the top of the paper
            document.getElementById('budgetDisplay').textContent = `Budget: ¬£${params.budget}`;
            
            // Show loading overlay immediately
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // Wait for food data to load first
                console.log('üîÑ Loading food data...');
                await initializeFoodData();
                
                // Clean up the shopping list using Claude AI only
                console.log('üöÄ Starting Claude AI filtering process...');
                const cleanedItems = await cleanupShoppingList(params.shoppingList);
                
                // Hide the loading overlay since processing is complete
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Store the cleaned items globally
                currentShoppingList = cleanedItems;
                currentItemIndex = 0;
                
                // Display the cleaned shopping items in the list
                const shoppingListElement = document.getElementById('shoppingList');
                if (cleanedItems.length === 0) {
                    // Show message if no valid grocery items were found
                    shoppingListElement.innerHTML = '<li>No valid grocery items found in your list</li>';
                } else {
                    // Update the display and start processing alternatives
                    updateShoppingListDisplay();
                    // Start processing the first item
                    await processNextItem();
                }
                
                console.log('‚úÖ Claude AI filtering completed successfully');
            } catch (error) {
                // Handle any errors that occur during AI processing
                console.error('‚ùå Claude AI filtering failed:', error);
                // Hide loading overlay and show error message
                document.getElementById('loadingOverlay').style.display = 'none';
                const shoppingListElement = document.getElementById('shoppingList');
                shoppingListElement.innerHTML = '<li>Error filtering your shopping list. Please try again.</li>';
            }
        }
        
        // Navigation function to return to the main budget form page
        function goBack() {
            window.location.href = 'index.html';
        }
        
        // Initialize the page when the DOM is fully loaded
        // This ensures all HTML elements are available before JavaScript runs
        document.addEventListener('DOMContentLoaded', function() {
            initializeFoodData(); // Load food data first
            displayShoppingList(); // Start the shopping list display process
        });
    </script>
</body>
</html>
