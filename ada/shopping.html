<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic HTML document setup -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetWise - Shopping List</title>
    <!-- Link to external CSS file for base styling -->
    <link rel="stylesheet" href="styles.css">
    <!-- Inline styles specific to this shopping page -->
    <style>
        /* Shopping page specific styles */
        /* Body styling with background image */
        body {
            background-image: url('./assets/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            width: 100%;
            overflow-x: hidden;
        }
        
        /* Main container for the shopping page layout */
        .shopping-container {
            position: relative;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
        }
        
        /* Shopping list paper - styled to look like a real piece of paper */
        .shopping-paper {
            width: 300px;
            height: 450px;
            background: #FFF8DC; /* Cream color for paper */
            border-radius: 15px;
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.3), /* Drop shadow for depth */
                inset 0 1px 0 rgba(255, 255, 255, 0.8); /* Inner highlight */
            padding: 30px;
            transform: rotate(-2deg); /* Slight rotation for natural look */
            border: 3px solid #F5DEB3; /* Light brown border */
            margin-left: 30px;
            position: relative; /* Needed for loading overlay positioning */
        }
        
        /* Loading overlay that appears while AI processes the shopping list */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 248, 220, 0.9); /* Semi-transparent paper color */
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10; /* Above other content */
        }
        
        /* Animated spinner for loading indication */
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #F5DEB3; /* Light border */
            border-top: 3px solid #8B4513; /* Dark top border for rotation effect */
            border-radius: 50%;
            animation: spin 1s linear infinite; /* Continuous rotation */
            margin-bottom: 15px;
        }
        
        /* Keyframe animation for spinner rotation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Text that appears below the loading spinner */
        .loading-text {
            color: #8B4513; /* Dark brown to match theme */
            font-size: 1em;
            font-weight: 500;
            text-align: center;
        }
        
        .paper-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 3px solid #8B4513;
            padding-bottom: 15px;
        }
        
        .paper-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #8B4513;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .budget-display {
            font-size: 1.2em;
            color: #2F4F4F;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .shopping-list {
            list-style: none;
            padding: 15px;
            margin: 0;
            max-height: 280px; /* Limit height to make it scrollable */
            overflow-y: auto; /* Enable vertical scrolling */
            background: #FFF8DC; /* Same color as paper */
            border: 2px solid #8B4513; /* Dark brown border like a text field */
            border-radius: 8px; /* Rounded corners to match paper */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); /* Inner shadow for field effect */
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
        }
        
        .shopping-list li {
            padding: 4px 0;
            color: #2F4F4F;
            font-size: 1em;
            font-weight: 500;
            border-bottom: none; /* Remove lines between items */
            margin-bottom: 2px;
        }
        
        .shopping-list li:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Custom scrollbar styling to match the paper theme */
        .shopping-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .shopping-list::-webkit-scrollbar-track {
            background: #F5DEB3; /* Light brown track */
            border-radius: 4px;
        }
        
        .shopping-list::-webkit-scrollbar-thumb {
            background: #8B4513; /* Dark brown thumb */
            border-radius: 4px;
        }
        
        .shopping-list::-webkit-scrollbar-thumb:hover {
            background: #654321; /* Darker brown on hover */
        }
        
        /* Back button */
        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            color: #FFF8DC;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .shopping-container {
                justify-content: center;
            }
            
            .shopping-paper {
                width: 280px;
                height: 400px;
                padding: 25px;
                margin-left: 0;
                transform: rotate(-1deg);
            }
            
            .back-button {
                top: 20px;
                left: 20px;
                padding: 12px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <!-- Main container for the shopping page -->
    <div class="shopping-container">
        <!-- Navigation button to return to the main budget form -->
        <button class="back-button" onclick="goBack()">‚Üê Back to Budget</button>
        
        <!-- Shopping list paper - the main content area -->
        <div class="shopping-paper">
            <!-- Loading overlay that shows while AI processes the shopping list -->
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">AI is cleaning up your shopping list...</div>
            </div>
            
            <!-- Header section of the paper with title and budget -->
            <div class="paper-header">
                <h2 class="paper-title">Shopping List</h2>
                <div class="budget-display" id="budgetDisplay">Budget: ¬£0</div>
            </div>
            <!-- List container where cleaned shopping items will be displayed -->
            <ul class="shopping-list" id="shoppingList">
                <!-- Shopping items will be populated by JavaScript after AI processing -->
            </ul>
        </div>
    </div>
    
    <script>
        // Function to extract budget and shopping list data from URL parameters
        // This allows data to be passed from the main form to this shopping page
        function getUrlParameters() {
            // Create URLSearchParams object to parse query string
            const urlParams = new URLSearchParams(window.location.search);
            return {
                budget: urlParams.get('budget') || '0', // Get budget amount, default to '0'
                shoppingList: urlParams.get('list') || '' // Get shopping list, default to empty string
            };
        }
        
        // AI cleanup function that processes and validates the shopping list
        // This uses Google AI to clean up grammar, remove invalid items, and standardize format
        async function cleanupShoppingList(shoppingList) {
            try {
                // Use Google AI API for all cleanup tasks
                const cleanedItems = await callAIAPI(shoppingList);
                return cleanedItems;
                
            } catch (error) {
                // If AI fails, use basic fallback processing
                console.log('üîÑ Google AI API failed, using basic fallback processing');
                
                // Basic cleanup without AI - handle periods as separators too
                const items = shoppingList.split(/[,;]/).map(item => {
                    // Also split on periods if they're clearly separators
                    return item.split('.').map(subItem => subItem.trim()).filter(subItem => subItem.length > 0);
                }).flat().filter(item => item.length > 0);
                
                // Basic grocery item validation and cleanup
                const groceryItems = items.filter(item => {
                    const lowerItem = item.toLowerCase();
                    // Remove obvious non-grocery items
                    const nonGrocery = ['car', 'phone', 'computer', 'book', 'toy', 'game', 'clothes', 'shoes', 'house', 'apartment', 'bug', 'insect', 'animal'];
                    return !nonGrocery.some(nonGrocery => lowerItem.includes(nonGrocery));
                });
                
                // Basic spelling correction dictionary
                const corrections = {
                    'appples': 'apples',
                    'cucamber': 'cucumber',
                    'tomatos': 'tomatoes',
                    'potatos': 'potatoes',
                    'onions': 'onions',
                    'carrots': 'carrots',
                    'bananas': 'bananas',
                    'oranges': 'oranges',
                    'milk': 'milk',
                    'bread': 'bread',
                    'eggs': 'eggs',
                    'cheese': 'cheese',
                    'butter': 'butter',
                    'chicken': 'chicken',
                    'beef': 'beef',
                    'fish': 'fish',
                    'rice': 'rice',
                    'pasta': 'pasta',
                    'yogurt': 'yogurt',
                    'cereal': 'cereal',
                    'coffee': 'coffee',
                    'tea': 'tea',
                    'sugar': 'sugar',
                    'salt': 'salt',
                    'pepper': 'pepper',
                    'oil': 'cooking oil',
                    'flour': 'flour',
                    'soup': 'soup',
                    'cookies': 'biscuits',
                    'crackers': 'crackers',
                    'juice': 'fruit juice',
                    'water': 'water',
                    'soda': 'soft drinks',
                    'beer': 'beer',
                    'wine': 'wine'
                };
                
                // Apply spelling corrections
                const correctedItems = groceryItems.map(item => {
                    const lowerItem = item.toLowerCase();
                    // Check for exact matches first
                    if (corrections[lowerItem]) {
                        return corrections[lowerItem];
                    }
                    // Check for partial matches
                    for (const [wrong, correct] of Object.entries(corrections)) {
                        if (lowerItem.includes(wrong) || wrong.includes(lowerItem)) {
                            return correct;
                        }
                    }
                    // If no correction found, return original with proper capitalization
                    return item.charAt(0).toUpperCase() + item.slice(1).toLowerCase();
                });
                
                // Basic pluralization for duplicates
                const itemCounts = {};
                correctedItems.forEach(item => {
                    const lowerItem = item.toLowerCase();
                    itemCounts[lowerItem] = (itemCounts[lowerItem] || 0) + 1;
                });
                
                const result = [];
                Object.keys(itemCounts).forEach(item => {
                    const count = itemCounts[item];
                    const capitalized = item.charAt(0).toUpperCase() + item.slice(1);
                    
                    if (count > 1) {
                        // Simple pluralization
                        if (item.endsWith('y')) {
                            result.push(capitalized.slice(0, -1) + 'ies');
                        } else if (item.endsWith('s') || item.endsWith('sh') || item.endsWith('ch')) {
                            result.push(capitalized + 'es');
                        } else {
                            result.push(capitalized + 's');
                        }
                    } else {
                        result.push(capitalized);
                    }
                });
                
                console.log('üìù Basic fallback result:', result);
                return result;
            }
        }
        
        // Real AI API call function using Google AI Studio (Gemini)
        async function callAIAPI(shoppingList) {
            // Get your free API key from: https://makersuite.google.com/app/apikey
            const API_KEY = 'AIzaSyB6A1MUJL5SunCDI7BdhxZLrxNBZ0G0d_o'; // Replace with your actual Google AI API key
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;
            
            console.log('ü§ñ Calling Google AI API with list:', shoppingList);
            
            const prompt = `You are an intelligent shopping list parser for a UK grocery store. Your job is to understand what the user actually wants to buy, even if they write it poorly.

Original input: "${shoppingList}"

CRITICAL PARSING RULES:
1. SMART SEPARATION: Understand what are separate items vs. parts of one item name
   - "beans. bug" = "Beans, Bug" (two separate items)
   - "green beans" = "Green beans" (one item with descriptor)
   - "car car apples" = "Apples" (ignore non-grocery, keep grocery)
   - "apple pie" = "Apple pie" (one item)
   - "apple, pie" = "Apple, Pie" (two separate items)

2. INTELLIGENT PARSING: Look for natural separators and context
   - Commas, periods, semicolons, "and", "&" = separate items
   - Spaces within descriptive names = one item
   - Numbers + items = one item (e.g., "2 apples" = "Apples")

3. CONTEXT UNDERSTANDING: Use grocery store knowledge
   - "beans" = grocery item
   - "bug" = not a grocery item (remove)
   - "car" = not a grocery item (remove)
   - "green beans" = one grocery item
   - "baked beans" = one grocery item

YOUR TASKS:
1. PARSE CORRECTLY: Identify separate grocery items vs. single items with descriptors
2. GRAMMAR & SPELLING: Fix all mistakes and typos
3. REMOVE NON-GROCERY: Remove cars, phones, bugs, toys, electronics, etc.
4. UK TERMINOLOGY: Convert to British English (cookies‚Üíbiscuits, soda‚Üísoft drinks)
5. COMBINE DUPLICATES: If same item appears multiple times, make it plural
6. PROPER CAPITALIZATION: Capitalize correctly
7. STANDARDIZE NAMES: Use proper grocery store names

EXAMPLES:
- "car car apples" ‚Üí "Apples"
- "beans. bug" ‚Üí "Beans"
- "green beans, baked beans" ‚Üí "Green beans, Baked beans"
- "apple pie, apple" ‚Üí "Apple pie, Apple"
- "2 apples, 3 bananas" ‚Üí "Apples, Bananas"
- "cookies, soda" ‚Üí "Biscuits, Soft drinks"
- "please buy milk and bread" ‚Üí "Milk, Bread"

Return ONLY the cleaned grocery items as a comma-separated string. No explanations.`;
            
            try {
                console.log('üì° Making API request to:', API_URL);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: prompt
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 500,
                            topP: 0.8,
                            topK: 10
                        }
                    })
                });
                
                console.log('üìä API Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    throw new Error(`Google AI API error: ${response.status} - ${response.statusText}. Details: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ API Response data:', data);
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    console.error('‚ùå Invalid API response structure:', data);
                    throw new Error('Invalid response from Google AI API');
                }
                
                const cleanedText = data.candidates[0].content.parts[0].text.trim();
                console.log('üßπ AI cleaned text:', cleanedText);
                
                // Split the AI response into individual items - handle periods too
                const result = cleanedText.split(/[,;]/).map(item => {
                    // Also split on periods if they're clearly separators
                    return item.split('.').map(subItem => subItem.trim()).filter(subItem => subItem.length > 0);
                }).flat().filter(item => item.length > 0);
                
                console.log('üìù Final processed items:', result);
                return result;
                
            } catch (error) {
                console.error('‚ùå Google AI API call failed:', error);
                console.log('üîÑ Falling back to basic processing...');
                throw error;
            }
        }
        
        
        // Main function that displays the budget and processes the shopping list with AI
        async function displayShoppingList() {
            // Get the budget and shopping list from URL parameters
            const params = getUrlParameters();
            
            // Display the budget amount at the top of the paper
            document.getElementById('budgetDisplay').textContent = `Budget: ¬£${params.budget}`;
            
            try {
                // Clean up the shopping list using AI processing
                const cleanedItems = await cleanupShoppingList(params.shoppingList);
                
                // Hide the loading overlay since processing is complete
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Display the cleaned shopping items in the list
                const shoppingListElement = document.getElementById('shoppingList');
                if (cleanedItems.length === 0) {
                    // Show message if no valid grocery items were found
                    shoppingListElement.innerHTML = '<li>No valid grocery items found in your list</li>';
                } else {
                    // Create list items for each cleaned grocery item
                    shoppingListElement.innerHTML = cleanedItems.map(item => `<li>${item}</li>`).join('');
                }
            } catch (error) {
                // Handle any errors that occur during AI processing
                // Hide loading overlay and show error message
                document.getElementById('loadingOverlay').style.display = 'none';
                const shoppingListElement = document.getElementById('shoppingList');
                shoppingListElement.innerHTML = '<li>Error processing your shopping list. Please try again.</li>';
            }
        }
        
        // Navigation function to return to the main budget form page
        function goBack() {
            window.location.href = 'index.html';
        }
        
        // Initialize the page when the DOM is fully loaded
        // This ensures all HTML elements are available before JavaScript runs
        document.addEventListener('DOMContentLoaded', function() {
            displayShoppingList(); // Start the shopping list display process
        });
    </script>
</body>
</html>
